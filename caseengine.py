# 实例化引擎
engine = PathologyDiagnosticEngine()

# 输入病例数据
case_huang = {
    'clinical': {
        'age': 59,
        'sex': '女',
        'location': '左大腿内侧深部',
        'size': 20,  # cm
        'duration': 2,  # 月
        'growth': '进展性'
    },
    'histology': {
        'cell_type': '梭形细胞',
        'density': '密集',
        'atypia': '显著（大小形态不一）',
        'mitosis': '多见',
        'giant_cells': True
    },
    'ihc': {
        'MDM2': 1.0,
        'CDK4': 0.3,
        'Myoglobin': 1.0,
        'Myogenin': 0.0,
        'Desmin': 0.0,
        'SMA': 0.0,
        'S100': 0.0,
        'CD99': 1.0,
        'Ki67': 0.30
    }
}

# 运行诊断
result = engine.diagnose(case_huang)

# 输出
"""
========== 病理诊断报告 ==========

【诊断】去分化脂肪肉瘤（DDLPS），伴异源性横纹肌样分化

【置信度】95.2%

【诊断依据】
1. 分子标志物（决定性）：
   - MDM2 (+) [敏感性97%, 特异性100%]
   - CDK4 (少量+) [支持性证据]
   - 组合特异性：95%

2. 排除性证据（强支持）：
   - Myogenin (-) → 排除原发性RMS (置信度98%)
   - Desmin (-) → 排除原发性RMS/平滑肌肉瘤

3. 分化方向标志：
   - Myoglobin (+) → 异源性肌源性分化
   - 在DDLPS背景下合理（文献支持）

4. 临床支持：
   - 年龄/部位/大小 → 先验概率倾向DDLPS

【不确定性分析】
- 信息熵：0.21 (低，诊断确定性高)
- 敏感性分析：MDM2权重最高
- 形态学模糊度：中等（异源性分化）

【建议】
1. FISH检测MDM2扩增（必需）
   - 原因：穿刺标本量少，IHC敏感性在模糊病例中降至45%
   - 金标准确认

2. 临床处理：
   - 手术：广泛切除+阴性边界
   - 随访：高复发风险
   - 分期评估

【鉴别诊断】
- 多形性横纹肌肉瘤：已排除 (Myogenin/Desmin阴性)
- 未分化多形性肉瘤：MDM2阳性不支持
- 平滑肌肉瘤：SMA/Desmin阴性排除

【病理学家签名】[您的签名]
【日期】2026-01-26
================================
"""
```

---

## 四、可视化逻辑枢纽图
```
                    ┌─────────────────┐
                    │  临床信息输入    │
                    │  (年龄/性别/部位) │
                    └────────┬─────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │ 先验概率计算模块  │◄────── 流行病学数据库
                    │ P(D|Clinical)    │
                    └────────┬─────────┘
                             │
                    ┌────────┴─────────┐
                    │                  │
                    ▼                  ▼
           ┌────────────────┐  ┌────────────────┐
           │ 形态学分析模块  │  │  影像学分析     │
           │ 细胞类型/异型性 │  │  (可选整合)     │
           └────────┬───────┘  └────────┬───────┘
                    │                   │
                    └─────────┬─────────┘
                              │
                              ▼
                    ┌──────────────────────┐
                    │  免疫组化决策树模块   │
                    │  (分层筛查策略)       │
                    └──────────┬───────────┘
                               │
              ┌────────────────┼────────────────┐
              │                │                │
              ▼                ▼                ▼
      ┌─────────────┐  ┌─────────────┐  ┌─────────────┐
      │谱系归属判断  │  │特异性标志物  │  │排除性标志物  │
      │CK/EMA等     │  │MDM2/CDK4等  │  │Myogenin等   │
      └──────┬──────┘  └──────┬──────┘  └──────┬──────┘
             │                │                │
             └────────────────┼────────────────┘
                              │
                              ▼
                    ┌──────────────────────┐
                    │   逻辑推理引擎        │
                    │  (规则+概率混合)      │
                    │                      │
                    │  IF-THEN规则库       │
                    │  贝叶斯网络          │
                    │  冲突解决机制        │
                    └──────────┬───────────┘
                               │
                    ┌──────────┴───────────┐
                    │                      │
                    ▼                      ▼
         ┌─────────────────┐    ┌─────────────────┐
         │ 置信度评估模块   │    │ 不确定性量化     │
         │ P(D|所有证据)    │    │ 熵/CI/敏感性分析 │
         └─────────┬───────┘    └─────────┬───────┘
                   │                      │
                   └──────────┬───────────┘
                              │
                    ┌─────────▼──────────┐
                    │  决策门限判断       │
                    │  P > 0.90 → 确诊   │
                    │  0.70-0.90 → 建议检测│
                    │  < 0.70 → 重新评估 │
                    └─────────┬──────────┘
                              │
                    ┌─────────▼──────────┐
                    │  分子检测建议模块   │
                    │  FISH/NGS          │
                    └─────────┬──────────┘
                              │
                              ▼
                    ┌──────────────────────┐
                    │   最终诊断输出        │
                    │   • 主诊断           │
                    │   • 置信度           │
                    │   • 诊断依据         │
                    │   • 鉴别诊断         │
                    │   • 后续建议         │
                    └──────────────────────┘
                              │
                              ▼
                    ┌──────────────────────┐
                    │   反馈学习模块        │
                    │   (积累案例优化参数)  │
                    └──────────────────────┘